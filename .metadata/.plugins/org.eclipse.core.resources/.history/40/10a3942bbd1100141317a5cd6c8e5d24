package com.example.android_rspeak_v1.database;

import java.util.ArrayList;
import java.util.List;

import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.database.SQLException;
import android.database.sqlite.SQLiteDatabase;

public class QuestionsDataSource 
{
	// Database Fields
	private SQLiteDatabase database;
	private RSpeakSQLiteHelper dbHelper;
	private String[] allColumns = { 
			RSpeakSQLiteHelper.QUESTIONS_COLUMN_ID,
			RSpeakSQLiteHelper.QUESTIONS_COLUMN_CONTENT,
			RSpeakSQLiteHelper.QUESTIONS_COLUMN_TIME_POSTED,
			RSpeakSQLiteHelper.QUESTIONS_COLUMN_ON_ASKER_DEVICE };
	
	public QuestionsDataSource( Context context )
	{
		dbHelper = new RSpeakSQLiteHelper( context );
	}
	
	public void open() throws SQLException
	{
		database = dbHelper.getWritableDatabase();
	}
	
	public void close()
	{
		dbHelper.close();
	}
	
	public Question createQuestion( String question_content, 
			long time_posted )
	{
		ContentValues values = new ContentValues();
		
		values.put(RSpeakSQLiteHelper.QUESTIONS_COLUMN_CONTENT, question_content );
		values.put(RSpeakSQLiteHelper.QUESTIONS_COLUMN_TIME_POSTED, time_posted );
		
		long question_id = database.insert(RSpeakSQLiteHelper.TABLE_QUESTIONS, null, values);
		Cursor cursor = database.query(RSpeakSQLiteHelper.TABLE_QUESTIONS,
				allColumns, 
				RSpeakSQLiteHelper.QUESTIONS_COLUMN_ID + " = " + question_id,
				null,
				null,
				null,
				null);
		cursor.moveToFirst();
		Question newQuestion = cursorToQuestion( cursor );
		cursor.close();
		return newQuestion;
	}
	
	public void deleteQuestion(Question question)
	{
		long question_id = question.getQuestionID();
		
		database.delete(RSpeakSQLiteHelper.TABLE_QUESTIONS, 
				RSpeakSQLiteHelper.QUESTIONS_COLUMN_ID + " = " + question_id, 
				null);
	}
	
	private List<Question> queryAllQuestions(String conditions)
	{
		List<Question> questions = new ArrayList<Question>();
		
		Cursor cursor = database.query(RSpeakSQLiteHelper.TABLE_QUESTIONS,
				allColumns,
				conditions,
				null,
				null,
				null,
				null);
		
		cursor.moveToFirst();
		while (!cursor.isAfterLast()) 
		{
			Question question = cursorToQuestion(cursor);
			questions.add(question);
			cursor.moveToNext();
		}
		
		cursor.close();
		return questions;
	}
	
	public List<Question> getAllThreads()
	{
		return queryAllQuestions( null );
	}
	
	public Question getQuestionById( long question_id )
	{
		return queryAllQuestions(
				RSpeakSQLiteHelper.QUESTIONS_COLUMN_ID +
				" = '" +
				question_id + 
				"'" ).get( 0 );
	}
	
	public List<Question> getLocallyAskedThreads()
	{
		return queryAllQuestions( RSpeakSQLiteHelper.THREADS_COLUMN_ON_ASKER_DEVICE + " = 1" );
	}
	
	public List<Question> getForeignAskedThreads()
	{
		return queryAllQuestions( RSpeakSQLiteHelper.THREADS_COLUMN_ON_ASKER_DEVICE + " = 0" );
	}
	
	private Question cursorToQuestion(Cursor cursor)
	{
		Question question = new Question();
		
		question.setQuestionID(
				cursor.getLong(
						cursor.getColumnIndex(RSpeakSQLiteHelper.QUESTIONS_COLUMN_ID)));
		question.setQuestionContent(
				cursor.getString(
						cursor.getColumnIndex(RSpeakSQLiteHelper.QUESTIONS_COLUMN_CONTENT)));
		question.setTimePosted(
				cursor.getLong(
						cursor.getColumnIndex(RSpeakSQLiteHelper.QUESTIONS_COLUMN_TIME_POSTED)));
		
		return question;
	}
}
